<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="/node_modules/xterm/css/xterm.css" />
    <script src="/node_modules/xterm/lib/xterm.js"></script>
    <script src="/node_modules/xterm-addon-attach/lib/xterm-addon-attach.js"></script>
    <script src="/node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="/node_modules/monaco-editor/min/vs/loader.js"></script>

    <style>
        * {
            margin: 0;
        }
        html, body {
            height: 100%;
        }
        .container {
            height: 100%;
        }
        .container #terminal {
            width: 100%;
            height: 30vh;
        }

        .container .editor {
            width: 100%;
            height: 65vh;
        }

        .container #editor-container {
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor">
            <form id="fileUpload">
                Upload files into <i>/sandbox</i>
                <input type="file" id="fileUploadInput" multiple/>
                <input type="submit" id="fileUploadSubmit"/>
            </form>

            <form id="fileOps">
                <button type="submit" id="fileOpsSave">Save to</button>
                <button type="submit" id="fileOpsOpen">Open from</button>
                <input type="text" id="fileOpsPath" value="/sandbox/main.cpp"/>
            </form>

            <div id="editor-container"></div>
        </div>

        <div id="terminal"></div>
    </div>

    <script>
        const apiUrl = `${window.location.protocol}//${window.location.host}`

        let id = null;
        let editor = null;

        const setFileUploadDisabled = value => {
            document.querySelector("#fileUploadSubmit").disabled = value;
            document.querySelector("#fileUploadInput").disabled = value;
        }

        const setFileOpsDisabled = value => {
            document.querySelector("#fileOpsPath").disabled = value;
            document.querySelector("#fileOpsSave").disabled = value;
            document.querySelector("#fileOpsOpen").disabled = value;
        }

        document.querySelector("#fileUpload").addEventListener('submit', async e => {
            e.preventDefault();

            setFileUploadDisabled(true);

            const body = new FormData();

            for (const file of document.querySelector("#fileUploadInput").files)
                body.append('files', file, file.name);

            const res = await fetch(`${apiUrl}/sandbox/${id}/upload`, {method: "POST", body});

            setFileUploadDisabled(false);
        });

        document.querySelector("#fileOps").addEventListener('submit', async e => {
            e.preventDefault();
        });

        document.querySelector("#fileOps").addEventListener('submit', e => e.preventDefault());

        document.querySelector("#fileOpsSave").addEventListener('click', async e => {

            setFileOpsDisabled(true);

            const content = new Blob([editor.getValue()], {
                type: 'text/plain'
            });

            const body = new FormData();
            body.append('files', content, document.querySelector("#fileOpsPath").value);

            await fetch(`http://localhost:3000/sandbox/${window.id}/upload`, {method: "POST", body});

            setFileOpsDisabled(false);
        });

        document.querySelector("#fileOpsOpen").addEventListener('click', async e => {

            setFileOpsDisabled(true);

            const path = document.querySelector("#fileOpsPath").value;

            const res = await fetch(`http://localhost:3000/sandbox/${window.id}/download`, {
                method: "POST", 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({path})}
            );

            const data = await res.json();
            const file = data.files[0];
            editor.setValue(file.content);

            setFileOpsDisabled(false);
        });

        (async () => {
            const res = await fetch(`${apiUrl}/sandbox/`, {method: "POST"});
            id = (await res.json()).id;
            window.id = id;
            
            const terminal = new Terminal();
            const socket = new WebSocket(`ws://localhost:3000/sandbox/${id}`);
            const attachAddon = new AttachAddon.AttachAddon(socket);
            const fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(attachAddon);
            terminal.loadAddon(fitAddon);
            terminal.open(document.querySelector("#terminal"));
            new ResizeObserver(() => fitAddon.fit()).observe(document.querySelector("#terminal"));
            editor?.layout();
        })();

        window.resize = () => editor?.layout();

        require.config({ paths: { vs: '/node_modules/monaco-editor/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.querySelector('#editor-container'), {
                // automaticLayout: true,
                value: `
#include <cstdio>
int main() {
    printf("Hello, world!");
    return 0;
}
`,
                language: 'cpp'
            });

            editor.layout();
        });
    </script>
</body>
</html>